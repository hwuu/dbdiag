<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DBDIAG Web Console</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div id="terminal">
        <div id="output"></div>
        <div id="input-line">
            <span class="prompt">&gt; </span>
            <input type="text" id="input" autofocus
                   placeholder="输入问题描述开始诊断...">
        </div>
    </div>

    <script>
        // WebSocket 连接
        const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
        const ws = new WebSocket(`${protocol}//${location.host}/ws/chat`);

        const output = document.getElementById('output');
        const input = document.getElementById('input');

        // 连接状态
        let connected = false;

        ws.onopen = () => {
            connected = true;
            console.log('WebSocket connected');
        };

        ws.onclose = () => {
            connected = false;
            output.innerHTML += '<div class="system-message">连接已断开。刷新页面重新连接。</div>';
        };

        ws.onerror = (error) => {
            console.error('WebSocket error:', error);
            output.innerHTML += '<div class="error-message">连接错误，请刷新页面重试。</div>';
        };

        ws.onmessage = (event) => {
            const msg = JSON.parse(event.data);

            if (msg.type === 'output') {
                // 追加 HTML 输出
                const div = document.createElement('div');
                div.className = 'output-block';
                div.innerHTML = msg.html;

                // 清理内联背景色
                div.querySelectorAll('*').forEach(el => {
                    el.style.removeProperty('background');
                    el.style.removeProperty('background-color');
                });

                output.appendChild(div);

                // 滚动到底部
                output.scrollTop = output.scrollHeight;
            } else if (msg.type === 'close') {
                // 服务端请求关闭
                if (msg.html) {
                    const div = document.createElement('div');
                    div.className = 'output-block';
                    div.innerHTML = msg.html;

                    // 清理内联背景色
                    div.querySelectorAll('*').forEach(el => {
                        el.style.removeProperty('background');
                        el.style.removeProperty('background-color');
                    });

                    output.appendChild(div);
                }
                ws.close();
            }
        };

        // 输入处理
        input.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && input.value.trim()) {
                const content = input.value.trim();

                if (!connected) {
                    output.innerHTML += '<div class="error-message">未连接到服务器，请刷新页面。</div>';
                    return;
                }

                // 回显用户输入
                const echoDiv = document.createElement('div');
                echoDiv.className = 'user-input';
                echoDiv.textContent = '> ' + content;
                output.appendChild(echoDiv);

                // 发送消息
                if (content.startsWith('/')) {
                    ws.send(JSON.stringify({type: 'command', content: content}));
                } else {
                    ws.send(JSON.stringify({type: 'message', content: content}));
                }

                // 清空输入框
                input.value = '';

                // 滚动到底部
                output.scrollTop = output.scrollHeight;
            }
        });

        // 点击页面时聚焦输入框
        document.addEventListener('click', () => {
            input.focus();
        });
    </script>
</body>
</html>
